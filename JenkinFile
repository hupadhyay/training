pipeline{

	environment {
    	registry = "hupadhyay/training"
    	registryCredential = 'Himpc@700'
    	dockerImage = ''
	}

	agent any

	tools {
        maven 'maven3' 
    }
	
	stages{
		stage('Compile Stage'){
			steps{
				bat 'mvn clean compile'
			}
		}
	
		stage('Validate Stage'){
			steps{
				bat 'mvn pmd:pmd'
				bat 'mvn checkstyle:checkstyle'
			}
		}
		
		stage('Package Stage'){
			steps{
				bat 'mvn clean package'
			}
		}
		
		stage('Building Image'){
			steps{
				echo 'Build the image and pushInto docker hub repository'
				script{
					dockerImage = docker.build registory + ":$BUILD_NUMBER"
				}
			}
		}
		
		stage('Deploy Image') {
      		steps{
        		script {
          			docker.withRegistry( '', registryCredential ) {
            			dockerImage.push()
          			}
        		}
    		}
		}
    	
    	stage('Remove Unused docker image') {
      		steps{
        		sh "docker rmi $registry:$BUILD_NUMBER"
      		}
    	}
	}
}